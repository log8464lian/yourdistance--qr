<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <title>å±±æµ·å¯å¹³ï¼Œä¸è´Ÿç›¸é‡</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <link rel="manifest" href="manifest.json">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,"Helvetica Neue",Arial;background:#fff9f9;height:100vh;overflow:hidden}
    #okBtn{background:#ff006e;color:#fff;border:none;padding:14px 28px;border-radius:30px;font-size:18px;letter-spacing:1px}
    .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.15);padding:24px 32px;max-width:280px;text-align:center;z-index:9999}
    .modal h3{margin-bottom:12px;font-size:20px}
    .pop{
      position:absolute;
      padding:14px 22px;
      border-radius:20px;
      font-size:16px;
      color:#fff;
      text-shadow:0 1px 3px rgba(0,0,0,.35);
      box-shadow:0 8px 24px rgba(0,0,0,.15);
      /* æ¯›ç»ç’ƒ */
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
      background:rgba(255,255,255,.18);   /* åŠé€æ˜åº•è‰² */
      animation:fadeIn .7s cubic-bezier(.22,.61,.36,1);
       z-index: 10;
    }
    @keyframes fadeIn{
      from{opacity:0;transform:translateY(20px) scale(.92)}
      to{opacity:1;transform:translateY(0) scale(1)}
    }

    /* å³ä¸Šè§’éŸ³ä¹å¼€å…³ */
    #musicCtrl{
      position:fixed;
      top:12px;
      right:12px;
      width:44px;
      height:44px;
      border:none;
      border-radius:50%;
      background:rgba(255,255,255,.9);
      box-shadow:0 2px 8px rgba(0,0,0,.2);
      font-size:22px;
      line-height:44px;
      text-align:center;
      cursor:pointer;
      z-index:9999;
    }
    body{
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* ===== æ–°å¢ï¼šå…¨å±è‡ªé€‚åº”èƒŒæ™¯ ===== */
    body {
      background: #fff9f9 url('bg.jpg') no-repeat center/cover fixed;
    }
    /* æ‰‹æœºç«¯å…¼å®¹ï¼šé˜²æ­¢éƒ¨åˆ†æµè§ˆå™¨å¯¹ fixed èƒŒæ™¯ä¸æ¸²æŸ“æˆ–æŠ–åŠ¨ */
    @media (max-width: 768px) {
      body {
        background-attachment: initial;   /* å…è®¸éšå†…å®¹æ»šåŠ¨ï¼Œé¿å…é»‘å±/ç©ºç™½ */
      }
    }
  </style>
</head>

<body>
  <!-- éŸ³ä¹ -->
  <button id="musicCtrl" title="éŸ³ä¹å¼€å…³">ğŸµ</button>
  <audio id="bgMusic" src="bgm.mp3" loop muted autoplay></audio>

  <!-- åˆå§‹ç¡®è®¤æ¡† -->
  <div id="confirm" class="modal">
    <h3>å¿ƒåŠ¨å¯å°</h3>
    <p style="margin:12px 0;color:#555">é•¿ä½©æ–‡å­¦å…¬å­ä¼˜ã€Šä½ çš„è·ç¦»ã€‹å¿ƒåŠ¨è¯­å½•ï¼Œç‚¹å‡»æŸ¥çœ‹â†’</p>
    <button id="okBtn" disabled>è§£é”</button>
  </div>

  <script>
  window.addEventListener('error', e => {
    alert('èµ„æºåŠ è½½å¤±è´¥ï¼š' + e.filename + '\n' + e.message);
  }, true);
  /* ========== æ–°å¢ï¼šç»´æŠ¤å½“å‰åœ¨å±ä¸Šçš„ pop èŠ‚ç‚¹ ========== */
  const MAX_POP = 24;          // åŒæ—¶æœ€å¤šä¿ç•™å‡ ä¸ª
  const popStack = [];        // æŒ‰ç”Ÿæˆé¡ºåºä¿å­˜èŠ‚ç‚¹å¼•ç”¨

  /* ========== éŸ³ä¹æ§åˆ¶ ========== */
  const bgMusic = document.getElementById('bgMusic');
  const musicBtn = document.getElementById('musicCtrl');

  /* å–æ¶ˆé™éŸ³ + æ¢å¤åˆ°æ­£å¸¸éŸ³é‡ */
  bgMusic.volume = 1;
  bgMusic.muted = false;
  musicBtn.textContent = 'â™«';   // åˆå§‹ä¸ºæ­£åœ¨æ’­æ”¾çŠ¶æ€

  /* ç‚¹å‡»å›¾æ ‡å¼€å…³ */
  musicBtn.onclick = () => {
    if (bgMusic.paused) {
      bgMusic.play();
      musicBtn.textContent = 'â™«';
    } else {
      bgMusic.pause();
      musicBtn.textContent = 'â™ª';
    }
  };

  /* ========== å¼¹çª—é€»è¾‘ ========== */
  let colors = [],
      sentencePool = [],
      allSentences = [];

  fetch('data.json')
    .then(r => r.json())
    .then(d => {
      colors  = d.colors;
      allSentences = d.sentences;
      shuffle(allSentences);
      sentencePool = [...allSentences];
      document.getElementById('okBtn').disabled = false;
    })
    .catch(err => alert('åŠ è½½é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ'));

  document.getElementById('okBtn').disabled = true;
  const okBtn = document.getElementById('okBtn');
  const confirmBox = document.getElementById('confirm');

  okBtn.onclick = () => {
    confirmBox.style.display = 'none';
    startRain();
  };

  function rand(n) {
    return Math.floor(Math.random() * n);
  }

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  function nextSentence() {
    if (!sentencePool.length) {          // æœ¬è½®çœŸæ­£ç”¨å®Œ
      shuffle(allSentences);             // é‡æ–°æ´—ç‰Œ
      sentencePool = [...allSentences];  // å»ºæ–°æ± 
    }
    return sentencePool.pop();
  }

  function createOne() {
    const p = document.createElement('div');
    p.className = 'pop';

    /* ===== å…ˆç®—å˜é‡ï¼Œå†ä½¿ç”¨ ===== */
    const MARGIN = 40;                // å·¦å³å®‰å…¨è¾¹è·
    p.style.left = MARGIN + rand(
      Math.max(0, window.innerWidth - p.offsetWidth - MARGIN * 2)
    ) + 'px';
    p.style.top  = rand(window.innerHeight - 80) + 'px';
    /* =========================== */

    p.style.background = colors[rand(colors.length)];
    p.textContent = nextSentence();
    document.body.appendChild(p);

    popStack.push(p);
    if (popStack.length > MAX_POP) {
      const old = popStack.shift();
      old.parentNode && old.parentNode.removeChild(old);
    }
  }
    
  function startRain() {
    function tick() {
      createOne();                       // æ˜¾ç¤ºä¸€æ¡
      setTimeout(tick, 1100);            // ç­‰ 1.1 ç§’å†ä¸‹ä¸€æ¡
    }
    tick();                              // å¯åŠ¨ç¬¬ä¸€æ¡
  }

  </script>
</body>
</html>